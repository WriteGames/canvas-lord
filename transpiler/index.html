<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>CL Transpiler</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="color-scheme" content="dark light" />
		<link rel="stylesheet" href="/css/reset.css" />
		<link rel="stylesheet" href="/css/styles.css" />
		<script src="http://localhost:3009/socket.io/socket.io.js"></script>
		<script type="module">
			const _origin = window.location.port
				? window.location.origin.replace(`:${window.location.port}`, '')
				: window.location.origin;
			const origin = `${_origin}:${3009}`;

			const clSocket = io(origin);
			window.clSocket = clSocket;

			clSocket.on('connect', () => {
				console.clear();
			});

			clSocket.on('contents', (msg) => {
				const data = JSON.parse(msg);

				const root = document.getElementById('tree-root');

				const available = new Map(data.available);
				data.available.forEach(([id, data]) => {
					const details = document.createElement('details');
					// TODO(bret): make this clickable!!
					const summary = document.createElement('summary');
					summary.innerHTML = `<code title="${data.filePath}">${id}</code>`;
					details.append(summary);
					details.setAttribute('open', undefined);
					root.append(details);

					const subTree = document.createElement('ul');

					const li = document.createElement('li');
					li.innerHTML = `File: <code>${data.filePath}</code>`;
					subTree.append(li);

					const [componentsTree, systemsTree] = [
						'Components',
						'Systems',
					].map((text) => {
						const li = document.createElement('li');
						li.textContent = text;
						subTree.append(li);
						const ul = document.createElement('ul');
						li.append(ul);
						return ul;
					});

					data.exports.components.forEach((c) => {
						const li = document.createElement('li');
						li.innerHTML = `<code>${c.name}</code>`;
						componentsTree.append(li);
						const ul = document.createElement('ul');
						li.append(ul);
						c.properties?.forEach(
							({ name, type, initialValue }) => {
								const li = document.createElement('li');
								li.innerHTML = `<code>${name}: ${type} = ${initialValue}</code>`;
								ul.append(li);
							},
						);
					});

					data.exports.systems.forEach((c) => {
						const li = document.createElement('li');
						li.innerHTML = `<code>${c.name}</code>`;
						systemsTree.append(li);
					});

					details.append(subTree);
				});

				inputId.value = data.input;
			});

			window.save = () => {
				clSocket.emit('chat message', inputId.value);
			};
		</script>
		<style>
			.three-column-layout {
				--max-width: 100ch;
			}

			main {
				padding-block: 1rem;
				gap: 1rem;
			}

			section {
				width: 100%;
				padding: 1rem;
				border: 1px dashed white;
			}

			ul {
				padding-inline-start: 40px;
			}
		</style>
	</head>
	<body class="three-column-layout">
		<header>
			<div>Tutorial Editor</div>
		</header>
		<main>
			<section>
				<input id="inputId" type="text" />
				<button onClick="save()">Submit</button>
			</section>
			<section>
				<label>Tree</label>
				<div id="tree-root"></div>
			</section>
			<section>
				<label>Output</label>
				<textarea style="width: 100%" rows="6" id="output"></textarea>
			</section>
		</main>
		<header>
			<div>&copy; 2025 WriteGames.com</div>
		</header>
	</body>
</html>
